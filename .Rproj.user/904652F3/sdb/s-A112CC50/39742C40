{
    "contents" : "library(zoo)\nlibrary(plyr)\nlibrary(ggplot2)\n# 1. read rawdata\n\nfwdRawDataFile <- \"./RawData/DubaiFwdHistory.csv\" # BrentFwdHistory.csv\nspotRawDateFile <- \"./RawData/DubaiSpotHistory.csv\" #BrentSpotHistory.csv\ncurrentBCHMark <- 'DUBAI' # ''BRENT\n\nfwdHistory <- read.csv(fwdRawDataFile)\nfwdHistory$FwdYM <- strtrim(fwdHistory$FwdYM,7)\nfwdHistory <- fwdHistory[fwdHistory$FwdPrice > 0 ,]\n  \nspotHistory <- read.csv(spotRawDateFile)\nspotHistory$YM <- as.yearmon(as.Date(spotHistory$QDate))\nspotHistory <- ddply(spotHistory, .(YM), mutate,\n                     IndexFromStart = index(SpotPrice))\n\nspotHistory$MMvAvg <- rollapplyr(spotHistory$SpotPrice\n                                , width = spotHistory$IndexFromStart  , mean , partial = F)\nspotHistory$YM <- NULL\nspotHistory$IndexFromStart <- NULL\n\n# 2. combine the data\n\nfullHistory <- merge(fwdHistory, spotHistory, by = \"QDate\", all=F)\n\n# 3. add structure info\n\n\nfwdStrBasicInfo <- fullHistory\n\nfwdStrBasicInfo$BCHMark <- currentBCHMark\nfwdStrBasicInfo$QDate <- as.Date(fwdStrBasicInfo$QDate , \"%Y-%m-%d\")\nfwdStrBasicInfo$FwdYM <- convertFYMStr2Date(fwdStrBasicInfo$FwdYM)\n\nfwdStrBasicInfo$MMDiff <- elapsed_months(fwdStrBasicInfo$FwdYM , fwdStrBasicInfo$QDate)\n\n\n# remove fwdprice on the month and replice it with spot price\n#fwdStrBasicInfo <- fwdStrBasicInfo[fwdStrBasicInfo$MMDiff > 0,]\n\nfwdStrBasicInfo$FwdPriceTy <- 'OR'\nFillMissingM0 <- ddply(fwdStrBasicInfo, .(QDate), summarise, QDate = QDate[1], FwdYM = convertFYMStr2Date(format(QDate[1], \"%Y-%m\")) , FwdPrice= MMvAvg[1], SpotPrice= SpotPrice[1], MMDiff = min(MMDiff), BCHMark = BCHMark[1], MMvAvg = MMvAvg[1], FwdPriceTy = 'CMV')\nFillMissingM0 <- FillMissingM0[FillMissingM0$MMDiff >0,]\nFillMissingM0$MMDiff <- 0\n\n\nfwdStrBasicInfo <- rbind(fwdStrBasicInfo, FillMissingM0)\nFillMissingM0 <- NULL\nfwdStrBasicInfo <- fwdStrBasicInfo[!is.na(fwdStrBasicInfo$SpotPrice),]\n\n# order data by QDate and FwdMM\nfwdStrBasicInfo <- fwdStrBasicInfo[order(fwdStrBasicInfo$QDate,fwdStrBasicInfo$MMDiff),]\nrownames(fwdStrBasicInfo) <- index(fwdStrBasicInfo)\nfwdStrBasicInfo$QYM <- convertFYMStr2Date(format(fwdStrBasicInfo$QDate, \"%Y-%m\"))\n\nfwdStrBasicInfo[as.yearmon(fwdStrBasicInfo$QDate) > as.yearmon(fwdStrBasicInfo$FwdYM),c('QDate','FwdYM')]\n#\nfwdStrBasicInfo.MonthAvg <- ddply(fwdStrBasicInfo, .(QYM, FwdYM), summarise, QYM = QYM[1], FwdYM = FwdYM[1], FwdPrice = mean(FwdPrice) , BCHMark = BCHMark[1])\nfwdStrBasicInfo.MonthAvg$MMDiff <- elapsed_months(fwdStrBasicInfo.MonthAvg$FwdYM , fwdStrBasicInfo.MonthAvg$QYM)\nfwdStrBasicInfo.MonthAvg <- fwdStrBasicInfo.MonthAvg[!is.na(fwdStrBasicInfo.MonthAvg$QYM),]\n\n# drawing the data\nstartRow <- as.integer(nrow(fwdStrBasicInfo)* 0 / 5)\nendRow <- as.integer(nrow(fwdStrBasicInfo) * 5 /5)\n\n#plotFwdCurves <- ggplot(data = fwdStrBasicInfo , aes(x = as.numeric(as.Date(FwdYM)), y = FwdPrice, group=QDate, color=as.numeric(format(QDate, \"%d\")))) +\nplotFwdCurves <- ggplot(data = fwdStrBasicInfo.MonthAvg , aes(x = as.numeric(as.Date(FwdYM)), y = FwdPrice, group=QYM)) +\n  \n   # geom_line(size=0.5,  aes(x = as.numeric(QDate), y = SpotPrice, group=NULL), color=\"red\") +  \n  geom_line(size=0.5) +\n  geom_line(data = fwdStrBasicInfo.MonthAvg[fwdStrBasicInfo.MonthAvg$FwdYM == fwdStrBasicInfo.MonthAvg$QYM,], size=1,  aes(x = as.numeric(as.Date(FwdYM)), y = FwdPrice, group=NULL), color=\"blue\")\n  \n\nprint(plotFwdCurves)\n\n\n\n",
    "created" : 1456378116306.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3188709393",
    "id" : "39742C40",
    "lastKnownWriteTime" : 1458350075,
    "path" : "D:/My_Workplace/Project/SKTIStudy/FwdStructureAnaly/FwdAnalysisModel/01_DataPreProcess.R",
    "project_path" : "01_DataPreProcess.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_source"
}