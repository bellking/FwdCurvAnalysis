{
    "collab_server" : "",
    "contents" : "createFwdStrInfo <- function(fwdStrBasicInfo)\n{\n  #structure for daily data\n  fwdStrBasicInfo <- ddply(fwdStrBasicInfo, .(QDate), mutate,\n                           FwdDelta = FwdPrice[1] - FwdPrice ,\n                           FwdDelta2 =FwdPrice[2] - FwdPrice , \n                           LongTermDelta = FwdPrice[1] - FwdPrice[max(index(FwdPrice))] ,\n                           FwdDeltaWPrev = c(0, - diff(FwdPrice, lag = 1))\n                           #FwdDeltaWPrev = c(0,FwdPrice[1:max(index(FwdPrice))-1] - FwdPrice[2:max(index(FwdPrice))])\n  )\n  \n  # add more structure data for daily average\n  fwdStrBasicInfo$SlopeFromOrg <- 0\n  fwdStrBasicInfo[fwdStrBasicInfo$MMDiff > 0 ,]$SlopeFromOrg <- fwdStrBasicInfo[fwdStrBasicInfo$MMDiff > 0 ,'FwdDelta'] / fwdStrBasicInfo[fwdStrBasicInfo$MMDiff > 0 ,'MMDiff']\n  fwdStrBasicInfo$LongTermStr <- 'BKWD'\n  fwdStrBasicInfo[fwdStrBasicInfo$LongTermDelta < 0,]$LongTermStr <- 'CNTG'\n  #fwdStrBasicInfo[fwdStrBasicInfo$LongTermDelta > 0,]$LongTermStr <- 'BKWD'\n  fwdStrBasicInfo\n}\n\ncreateCorrelation <- function(fwdStrBasicInfo, historyPeriod.start, historyPeriod.end, wid = 30, freq = 5)\n{\n  if (missing(historyPeriod.start))\n    historyPeriod.start <- min(fwdStrBasicInfo$QDate)\n  if (missing(historyPeriod.end))\n    historyPeriod.end <- max(fwdStrBasicInfo$QDate)\n\n  curveChangeAnaylsis <- fwdStrBasicInfo[fwdStrBasicInfo$QYM >= historyPeriod.start & fwdStrBasicInfo$QYM <= historyPeriod.end & fwdStrBasicInfo$MMDiff <31,]\n\n  curveChangeAnaylsis = ddply(curveChangeAnaylsis, .(FwdYM), mutate,\n                              SpotPriceDif = c(0, diff(SpotPrice, lag =1)),\n                              FwdPriceDif = c(0, diff(FwdPrice, lag = 1)))\n\n# #  curveChangeAnaylsis$Direction <- 'UP'\n# #  curveChangeAnaylsis[curveChangeAnaylsis$SpotPriceDif < 0 ,]$Direction <- 'DW'\n#   curveChangeAnaylsis$\n  \n  processData <- curveChangeAnaylsis[curveChangeAnaylsis$MMDiff ==0,]\n  curveChangeAnaylsis.summary <- getCorrelationAnalysisInfo(processData$FwdPriceDif,processData$SpotPriceDif,processData$QDate, wid, freq)\n  curveChangeAnaylsis.summary$MMDiff <- 0\n  \n  for(i in c(1:30))\n  {\n    processData <- curveChangeAnaylsis[curveChangeAnaylsis$MMDiff == i,]\n    analysisResult <- getCorrelationAnalysisInfo(processData$FwdPriceDif,processData$SpotPriceDif,processData$QDate, wid, freq)\n    analysisResult$MMDiff <- i\n    curveChangeAnaylsis.summary <- rbind(curveChangeAnaylsis.summary, analysisResult)\n  }\n  \n  return(curveChangeAnaylsis.summary)\n  \n  # curveChangeAnaylsis.summary <- ddply(curveChangeAnaylsis, .(MMDiff) , summarise,\n  #                                           getCorrelationAnalysisInfo(FwdPriceDif,SpotPriceDif,QDate))\n# \n#   curveChangeAnaylsis.summary <- ddply(curveChangeAnaylsis.summary, .(QYM) , mutate,\n#                        a                 correlRatio = correl / correl[1])\n}\n\ngetCorrelationAnalysisInfo <- function(col1, col2, qd, wid = 30, freq = 5)\n{\n # browser()\n  d <- data.frame(y = col1, x = col2)\n  d <- zoo(d, qd)\n  \n  # if (length(col1) < freq)\n  # {\n  #   return(NULL)\n  # }\n  \n    av <- rollapplyr(d,\n               width = wid  , \n               FUN = function(zz) summary(lm(y ~ x, data = as.data.frame(zz),na.action = na.omit))$coefficients[2,],\n               by = freq, by.column=FALSE,\n               partial = F)\n\n  \n  av <- as.data.frame(av)\n  av$QDate <- as.Date(rownames(av))\n  return(av)\n}\n\n# \n# getCorrelationAnalysisInfo <- function(priceInfo, compCol, wid , freq)\n# {\n#   d <- zoo(priceInfo[,compCol], priceInfo$QDate)\n#   colnames(d) <- c('y','x')\n#   rollapplyr(d,\n#              width = wid  , \n#              FUN = function(zz) summary(lm(y ~ x, data = as.data.frame(zz),na.action = na.omit))$coefficients[2,],\n#              by = freq, by.column=FALSE,\n#              partial = F)\n# }\n\n\ncreateSlopeAnalysis <- function(fwdStrBasicInfo , breakPoint , historyPeriod.start, historyPeriod.end)\n{\n  if (missing(historyPeriod.start))\n    historyPeriod.start <- min(fwdStrBasicInfo$QDate)\n  if (missing(historyPeriod.end))\n    historyPeriod.end <- max(fwdStrBasicInfo$QDate)\n \n  slopeTrend.Analy <- fwdStrBasicInfo[fwdStrBasicInfo$QYM >= historyPeriod.start & fwdStrBasicInfo$QYM <= historyPeriod.end & fwdStrBasicInfo$MMDiff %in% breakPoint,]\n  \n  missingQDates <- ddply(slopeTrend.Analy, .(QDate) , summarise, nn = length(FwdPrice))\n  missingQDates <- missingQDates[missingQDates$nn < length(breakPoint),]$QDate\n  \n  slopeTrend.Analy <- slopeTrend.Analy[!(slopeTrend.Analy$QDate %in% missingQDates),]\n  \n  slopeTrend.Analy <- ddply(slopeTrend.Analy, .(QDate) , mutate,\n                            PWSlope =  c(0, diff(FwdPrice, lag = 1) / diff(breakPoint, lag = 1)))\n  \n  slopeTrend.Analy.MAvg <- ddply(slopeTrend.Analy, .(QYM,MMDiff) , summarise,\n                                 PWSlope =  mean(PWSlope),\n                                 SpotPrice = mean(SpotPrice))\n  slopeTrend.Analy.MAvg$QDate <- slopeTrend.Analy.MAvg$QYM\n  \n  return(slopeTrend.Analy)\n}\n\n\n",
    "created" : 1463049764444.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1685395448",
    "id" : "8325A2B",
    "lastKnownWriteTime" : 1463102516,
    "last_content_update" : -2147483648,
    "path" : "D:/My_Workplace/Project/SKTIStudy/FwdStructureAnaly/FwdAnalysisModel/92_FwdStructureInfoFunction.R",
    "project_path" : "92_FwdStructureInfoFunction.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 24,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}