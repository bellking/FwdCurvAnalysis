{
    "collab_server" : "",
    "contents" : "elapsed_months <- function(end_date, start_date) {\n  \n  end_date <- as.Date(end_date)\n  start_date <- as.Date(start_date)\n  ed <- as.POSIXlt(end_date)\n  sd <- as.POSIXlt(start_date)\n  12 * (ed$year - sd$year) + (ed$mon - sd$mon)\n}\n\ngetYearMonth <- function(currentDate, shiftMonth) {\n  currentDate <- as.Date(currentDate)\n  mon <- month(currentDate)\n  mon <- mon + shiftMonth\n  yr <- floor((mon -1) / 12)\n  mon <- mon - yr * 12\n  yr <- year(currentDate) + yr\n  paste(yr, \"-\" , sprintf(\"%02d\",mon) , sep = \"\")\n}\n\n\ngetFwdStructure <- function(x, y) {\n  if (x < y)\n  {\n    return (\"CTNG\")\n  }\n  return (\"BKWD\")  \n}\n\n\nconvertFYMStr2Date <- function(x) {\n  as.Date(paste(x, \"-15\",sep =\"\") , \"%Y-%m-%d\")\n}\n\nmonthlyMeanSoFar <- function(p) {\n  refYearMon <- max(p$QDate)\n  #mean(p[as.yearmon(time(p)) == refYearMon])\n}\n\n\ngetDataFromDB <- function(crudeCategory, priceCategory) {\n  if (crudeCategory == 'DUBAI') {\n    crudeCodeSpot <- '10M10010'\n    crudeCodeFwd <- '90M90003'\n  }\n  else if (crudeCategory == 'WTI') {\n    crudeCodeSpot <- '80C80001'\n    crudeCodeFwd <- '90M90005'\n  }\n  else if (crudeCategory == 'BRENT'){\n    crudeCodeSpot <- '81C81001'\n    crudeCodeFwd <- '90M90002'\n  }\n  else if (crudeCategory == 'MOPS_FO180'){\n    crudeCodeSpot <- '11M11032'\n    crudeCodeFwd <- '90M90008'\n  }\n  else if (crudeCategory == 'MOPS_FO380'){\n    crudeCodeSpot <- '11M11029'\n    crudeCodeFwd <- '90M90032'\n  }\n  else\n  {\n    return\n  }\n  conn <-odbcConnect(\"IRMS_TEST\", uid=\"QUOT_VIEW_FOR_OPI\", pwd=\"456opi$%^\")\n  if(priceCategory == 'S') {\n    sql_str = paste(\"SELECT LEFT(QUOT_DATE,4)+'-'+SUBSTRING(QUOT_DATE,5,2)+'-'+RIGHT(QUOT_DATE,2) AS QDate, QUOT_PRICE AS SpotPrice FROM [dbo].[VW_MST_QUOT_VIEW_FOR_OPI] WHERE QUOT_NO = '\",crudeCodeSpot,\"' AND QUOT_DATE NOT LIKE '2060%' ORDER BY QUOT_DATE\",sep=\"\")\n  }\n  else {\n    sql_str = paste(\"SELECT LEFT(QUOT_DATE,4)+'-'+SUBSTRING(QUOT_DATE,5,2)+'-'+RIGHT(QUOT_DATE,2) AS QDate, LEFT(QUOT_PERIOD,4)+'-'+RIGHT(QUOT_PERIOD,2)+'-01' AS FwdYM, QUOT_PRICE AS FwdPrice FROM [dbo].[VW_MST_QUOT_VIEW_FOR_OPI] WHERE QUOT_NO = '\",crudeCodeFwd,\"' AND QUOT_PERIOD NOT LIKE '%13' AND LEN(QUOT_PERIOD) <= 6 ORDER BY QUOT_DATE, QUOT_PERIOD\",sep=\"\")\n  }\n  \n  sql_ret = sqlQuery(conn,sql_str)\n  odbcClose(conn)\n  \n  return (sql_ret)\n}\n\nwriteResult <- function(priceId, fwdContour.Monthly, fwdContour.Daily, correlation.Monthly\n                        ,fwdSlopeAnly.Daily, interestMMDiff) {\n  analysisResult <- fwdContour.Daily[ fwdContour.Daily$MMDiff %in% interestMMDiff ,c('QDate','MMDiff','FwdDelta','FwdYM')]\n  names(analysisResult) <- c('QDate','FwdMonth','CONTOUR_D','FwdYM')\n  analysisResult$FwdYM <- format(analysisResult$FwdYM, \"%Y-%m\")\n  \n  analysisResult.T <- fwdContour.Monthly[ fwdContour.Monthly$MMDiff %in% interestMMDiff ,c('QDate','MMDiff','FwdDelta')]\n  names(analysisResult.T) <- c('QDate','FwdMonth','CONTOUR_M')\n  analysisResult <- merge(analysisResult,analysisResult.T, by = c('QDate','FwdMonth') , all = T)\n  \n  analysisResult.T <- correlation.Monthly[,c('QDate','MMDiff','Estimate')]\n  names(analysisResult.T) <- c('QDate','FwdMonth','CORR_M')\n  analysisResult <- merge(analysisResult,analysisResult.T, by = c('QDate','FwdMonth') , all = T)\n  \n  analysisResult.T <- fwdSlopeAnly.Daily[,c('QDate','MMDiff','PWSlope')]\n  names(analysisResult.T) <- c('QDate','FwdMonth','SLOPE_D')\n  analysisResult <- merge(analysisResult,analysisResult.T, by = c('QDate','FwdMonth') , all = T)\n  \n  #analysisResult$PriceId <- priceId\n  analysisResult$FwdType <- paste(priceId , \"_\" ,sprintf(\"%02d\",analysisResult$FwdMonth))\n  \n  #write.csv(file = paste(priceId,\"_result.csv\"), x = analysisResult, row.names = F, na = \"\")\n  \n  return(analysisResult)\n}\n\nuploadResultToDB <- function(resultDF) {\n  resultDF$QDate <- as.character(resultDF$QDate)\n  resultDF$FwdMonth <- as.integer(resultDF$FwdMonth)\n  write.csv(file = \"FwdCurveAnalysis.csv\", x = resultDF, row.names = F, na = \"\")\n  \n  ftpUpload(\"FwdCurveAnalysis.csv\",\"ftp://168.154.221.100/OPI/FwdCurveAnalysis.csv\", userpw=\"irms_ftp:!@#qwe123\")\n\n  conn <-odbcConnect(\"IRMS_TEST\", uid=\"QUOT_VIEW_FOR_OPI\", pwd=\"456opi$%^\")\n  sqlQuery(conn, \"exec [dbo].[USP_BATCH_FWDCURVE_TO_TB_MST_QUOT]\")\n  odbcClose(conn)\n}\n",
    "created" : 1463125212259.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2717266261",
    "id" : "4BCA21DB",
    "lastKnownWriteTime" : 1463133708,
    "last_content_update" : 1463133708311,
    "path" : "D:/IRMS_R/90_CommonUtilFunction.R",
    "project_path" : "90_CommonUtilFunction.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}